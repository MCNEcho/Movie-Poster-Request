================================================================================
                    POSTER REQUEST SYSTEM - PROJECT DOCUMENTATION
                              Created: January 2026
                         For: Local Business (Pasco Theater)
================================================================================

PROJECT OVERVIEW
================================================================================

The Poster Request System is a Google Apps Script (GAS) automation solution built
to manage and control poster requests from employees at a local business. The
system combines Google Forms for user submissions, Google Sheets for data
management and tracking, and automated workflows for processing, validation,
and notifications.

PROBLEM STATEMENT & MOTIVATION
================================================================================

ORIGINAL ISSUE:
The poster request system was being abused and exploited. Without proper
controls in place, employees were able to:
  - Request unlimited numbers of posters
  - Request the same poster multiple times
  - Circumvent inventory tracking
  - Make requests without proper identification or accountability
  - Leave the system in an inconsistent state with orphaned data

BUSINESS IMPACT:
  - Loss of control over physical inventory
  - Inability to track who requested what and when
  - Difficulty managing poster distribution fairly
  - No audit trail for accountability
  - Manual workarounds that were error-prone

SOLUTION:
This Poster Request System was built to introduce strict controls, validation,
and automation that would:
  1. Limit each employee to a maximum of 5 active poster requests at any time
  2. Prevent duplicate requests (an employee can request each poster only once)
  3. Enforce proper employee identification (Name + Email from Google Account)
  4. Maintain a complete audit trail of all requests
  5. Automatically sync form options based on available inventory
  6. Notify interested employees when new posters are added
  7. Provide managers with visibility into all active requests

SYSTEM ARCHITECTURE
================================================================================

CORE TECHNOLOGY STACK:
  - Google Forms (for employee submissions)
  - Google Sheets (for data storage and employee-facing views)
  - Google Apps Script (V8 runtime) - JavaScript-based automation
  - Script Properties (for storing configuration and queue data)
  - Google Mail API (for notifications)
  - QuickChart API (for QR code generation in print layouts)

SPREADSHEET STRUCTURE:

1. MAIN SHEET
   - Read-only summary view for all staff
   - Shows all ACTIVE poster requests grouped by poster title
   - Displays inventory counts for each poster
   - Updated automatically whenever requests change
   - Format: Poster Title (Inventory Count) | Employee Name | Request Date

2. EMPLOYEES SHEET
   - Read-only summary view organized by employee
   - Shows which posters each employee has active requests for
   - Displays slot usage (e.g., "Gavin N (3/5)")
   - Synced to separate employee-view spreadsheet for sharing
   - Format: Employee Name (Slots Used/5) | Poster Title | Request Date

3. REQUESTS SHEET (Internal Ledger)
   - Complete audit log of all poster requests
   - Stores: Timestamp, Email, Name, Poster ID, Labels, Snapshots, Status
   - Records both ACTIVE and REMOVED requests
   - Never manually edited - only updated by the system
   - Used to calculate all summary views

4. REQUEST ORDER SHEET
   - Tracks every form submission attempt (approved and denied)
   - Shows what was requested, what was added, what was removed
   - Displays slots before/after for capacity tracking
   - Provides visibility into why requests were denied
   - Audit trail for troubleshooting

5. MOVIE POSTERS SHEET
   - Admin-maintained list of available posters
   - Columns: Active?, Poster ID, Title, Release Date, Inventory Count, Notes
   - Poster ID auto-generated and hidden from view
   - Active? checkbox controls which posters appear in the form
   - Close Queue? checkbox triggers announcements when activated
   - This sheet drives the form options dynamically

6. INVENTORY SHEET
   - Tracks physical poster stock counts
   - Synced from shipping/receiving
   - Automatically flows to Movie Posters sheet
   - Last Updated timestamp for reference
   - For informational purposes only (never blocks requests)

7. SUBSCRIBERS SHEET
   - List of employees who opt-in for poster announcements
   - Columns: Active?, Email, Name
   - New subscribers added automatically when they check notification box
   - Used to send batched emails about new posters every 15 minutes

8. PRINT OUT SHEET
   - Print-friendly inventory list with QR codes
   - Admin-generated from Movie Posters sheet
   - Includes Form URL and Employee View URL
   - QR codes for both Form and Employee View spreadsheet
   - Can be printed and posted in break rooms or offices

9. DOCUMENTATION SHEET
   - Auto-generated system documentation
   - Employee guide with name format requirements
   - Admin guide explaining each button and feature
   - System rules (5-slot limit, deduplication, etc.)
   - Troubleshooting help

PROJECT EVOLUTION & FEATURES IMPLEMENTED
================================================================================

PHASE 1: CORE INFRASTRUCTURE (Initial Build)
-------------------------------------------
Goals: Establish the basic request tracking system with validation

Implemented:
  ✓ Google Form with employee name, add/remove posters, notification opt-in
  ✓ Requests ledger sheet with complete audit trail
  ✓ Form submission handler (handleFormSubmit)
  ✓ Basic validation: Name format (FirstName LastInitial)
  ✓ Email auto-collection from Google Accounts
  ✓ Poster ID auto-generation and tracking

Features:
  - Form accepts only "FirstName LastInitial" format (e.g., "Gavin N")
  - Invalid submissions logged but not saved
  - Timestamp recorded for every submission
  - Employee email auto-collected (cannot be manually entered)

PHASE 2: REQUEST CONTROL & LIMITS (Abuse Prevention)
-----------------------------------------------------
Goals: Prevent system abuse through strict validation

Implemented:
  ✓ 5-poster maximum (MAX_ACTIVE) per employee
  ✓ Deduplication: Employee can request each poster only once ever
  ✓ Removal processing before addition processing
  ✓ Denial logging with clear reasons
  ✓ Slot capacity tracking and reporting

Features:
  - When submission exceeds 5-poster limit, excess requests are denied
  - Historical requests block future requests of same poster
  - Removals happen first, freeing slots for new additions
  - Denial reasons logged: "already requested", "limit (5-slot)", "inactive"
  - REQUEST_ORDER sheet shows exactly what was approved/denied

PHASE 3: DYNAMIC FORM SYNCING (Inventory Integration)
------------------------------------------------------
Goals: Keep form options synchronized with inventory and request status

Implemented:
  ✓ Form sync handler (syncPostersToForm)
  ✓ Active posters list (Active? = TRUE) in form Add section
  ✓ Remove posters list (posters with active requests) in form Remove section
  ✓ Inventory count sync from Inventory sheet to Movie Posters
  ✓ Label mapping for handling duplicate poster titles

Features:
  - Form automatically updates whenever Movie Posters sheet changes
  - Only active posters appear in "Request Posters (Add)"
  - Only posters employee has active requests appear in "Remove Posters"
  - If two posters have same title, release date appended to label
  - Inventory counts sync automatically but never block requests

PHASE 4: BOARD GENERATION & VIEWS (Employee Visibility)
--------------------------------------------------------
Goals: Provide clear, readable summaries for staff and admins

Implemented:
  ✓ Main board (buildMainBoard_)
  ✓ Employees board (buildEmployeesBoard_)
  ✓ Board rebuild trigger (handleSheetEdit)
  ✓ Automatic board styling and formatting
  ✓ Orphaned row cleanup

Features:
  - Main board: Grouped by poster title with inventory counts
  - Employees board: Grouped by employee with slot usage (X/5)
  - Sorted by release date for readability
  - Header rows auto-highlighted and merged for clarity
  - Boards automatically rebuild after every form submission
  - All rows below actual data are cleared to prevent orphaned entries

PHASE 5: ANNOUNCEMENTS & NOTIFICATIONS (Email Integration)
-----------------------------------------------------------
Goals: Keep interested employees informed about new posters

Implemented:
  ✓ Subscriber management system
  ✓ Automatic subscriber addition from form checkbox
  ✓ Announcement queue (ANNOUNCE_QUEUE)
  ✓ Time-based announcement processing (every 15 minutes)
  ✓ Custom announcements from admin menu
  ✓ Email sending to all active subscribers

Features:
  - Employees can opt-in via "Subscribe to Notifications" checkbox
  - Subscribers automatically added to Subscribers sheet with name
  - When poster is activated, announcement is queued
  - Batched emails sent every 15 minutes to all subscribers
  - Custom announcement feature for special messages
  - Supports {{FORM_URL}} and {{EMPLOYEES_URL}} tokens in custom messages
  - Prevents duplicate announcements (tracks already-announced IDs)

PHASE 6: ADMIN MENU & CONTROLS (Management Interface)
------------------------------------------------------
Goals: Provide admins with tools to manage the system

Implemented:
  ✓ Admin menu (buildAdminMenu_) with 12 action items
  ✓ Setup/Repair function (setupPosterSystem)
  ✓ Manual request entry for data migration
  ✓ Trigger management (ensureTriggers_)
  ✓ Sheet schema validation (ensureSheetSchemas_)

Admin Menu Items:
  1. Prepare Print Area (Select & Print)
     - Generates print-friendly inventory with QR codes
     - Selects optimal area for printing
  
  2. Run Setup / Repair
     - One-time initialization or system repair
     - Creates missing sheets, form, triggers
     - Rebuilds everything from scratch
  
  3. Sync Form Options Now
     - Manually update form with current active posters
     - Auto-runs after submissions
  
  4. Rebuild Boards Now
     - Refresh Main and Employees tabs from Requests sheet
     - Clear old data and rebuild from scratch
  
  5. Refresh Print Out
     - Updates Print Out tab with current inventory and posters
  
  6. Refresh Documentation
     - Rebuilds Documentation sheet with latest info
  
  7. Manually Add Request (for migration)
     - Opens dialog to manually add historical requests
     - For data migration from legacy systems
  
  8. Preview Pending Announcement
     - Shows draft of email that will be sent
  
  9. Send Announcement Now
     - Manually trigger email to all subscribers immediately
  
  10. Setup Employee View Spreadsheet
      - Creates separate read-only spreadsheet for employees
      - One-time setup only
  
  11. Sync Employee View Now
      - Manually copy Main/Employees data to employee spreadsheet
      - Clears old tabs and copies fresh versions
  
  12. Show Employee View Link
      - Displays URL of employee-view spreadsheet
      - Easy way to share with employees

PHASE 7: PRINT SYSTEM & QR CODES (Distribution)
------------------------------------------------
Goals: Create print-friendly materials for physical distribution

Implemented:
  ✓ Print layout builder (buildPrintOutLayout_)
  ✓ QuickChart QR code integration
  ✓ Dynamic QR code generation
  ✓ Fallback error handling for missing URLs
  ✓ Optimized print area selection

Features:
  - Print Out sheet contains inventory list with release dates
  - Form URL QR code at top (links to request form)
  - Employee View URL QR code below (links to summary view)
  - Employee-friendly for scanning with phones
  - Error messages if URLs are missing
  - Orphaned rows below content automatically cleared

PHASE 8: EMPLOYEE VIEW SPREADSHEET (Cross-Spreadsheet Sync)
-----------------------------------------------------------
Goals: Share read-only copy with employees without exposing admin data

Implemented:
  ✓ Separate employee-view spreadsheet creation
  ✓ Automated sync (syncEmployeeViewSpreadsheet_)
  ✓ Defensive error handling for failed copies
  ✓ Print Out tab URL auto-update
  ✓ Temporary sheet workaround for sheet deletion

Features:
  - Creates new spreadsheet named "[Original Name] (Employee View)"
  - Contains only Main and Employees sheets (read-only)
  - Shared with employees as Viewer (cannot edit)
  - Automatically synced when Setup or Sync buttons clicked
  - Safely deletes old tabs before copying new ones
  - Uses temporary sheet to work around Google API limitation
  - Supports cross-spreadsheet operations safely

PHASE 9: CODE OPTIMIZATION & DEBT REDUCTION (January 2026)
-----------------------------------------------------------
Goals: Eliminate redundant code and improve maintainability

Issues Fixed:
  ✗ Duplicate poster-fetching logic in multiple files
  ✗ Duplicate "get active requests" filtering
  ✗ Duplicate URL generation for employee view
  ✗ Dead code: fulfillAllActiveForPoster_() function
  ✗ Dead code: Close Queue auto-reset logic
  ✗ Orphaned employee names left on boards after removals
  ✗ Race condition in addSubscriber_ with concurrent submissions
  ✗ Redundant scanning in print area setup
  ✗ No error handling in employee view sync

Improvements Made:
  ✓ Created getPostersWithLabels_() utility function
  ✓ Created getActiveRequests_() utility function
  ✓ Removed fulfillAllActiveForPoster_() dead function
  ✓ Removed Close Queue reset logic
  ✓ Fixed orphaned rows with clearContent() in board builds
  ✓ Changed addSubscriber_ to use appendRow() for thread safety
  ✓ Added try-catch error handling to sheet copy operations
  ✓ Simplified print area row scanning logic
  ✓ Improved logging for debugging sheet copy operations

Results:
  - 95 lines of dead/duplicate code removed
  - 3 functions consolidated into utilities
  - 6+ instances of duplicate logic eliminated
  - Code is now more maintainable and consistent
  - Fewer bugs related to orphaned data
  - Better error recovery

TECHNICAL IMPLEMENTATION DETAILS
================================================================================

VALIDATION RULES:

1. Name Format Validation
   - Pattern: "FirstName LastInitial" (e.g., "Gavin N" or "Gavin N.")
   - First name: must be 2+ characters, starts with uppercase
   - Last initial: single letter (optional trailing period)
   - Invalid formats automatically rejected
   - Logging shows why submission failed

2. Email Validation
   - Auto-collected from Google Account (not user-entered)
   - Converted to lowercase for consistency
   - No manual email entry in form (Google Account enforced)

3. Poster Request Validation
   - Check if poster ID exists and is active
   - Check if employee has already requested that poster (ever)
   - Check if employee has available slots (max 5 active)
   - Process removals first to free up slots
   - Deny additions that fail any check with reason

4. Processing Order
   - Removals processed first (mark status as REMOVED)
   - Additions processed second (add new ledger rows)
   - Boards rebuilt after both complete
   - Form synced to reflect new Remove list
   - Announcements queued if applicable

LOCKING & CONCURRENCY:

Problem: Google Apps Script is single-threaded but triggers can fire
         simultaneously (e.g., two form submissions at same time)

Solution: LockService.getScriptLock() pattern used in all handlers
  - handleFormSubmit()
  - handleSheetEdit()
  - syncEmployeeViewSpreadsheet_()
  - prepareAndSelectPrintArea()

Pattern:
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);  // Wait up to 30 seconds
  try {
    // Critical section
  } finally {
    lock.releaseLock();  // Always release, even on error
  }

TRIGGERS & AUTOMATION:

Installed Triggers:
  1. handleFormSubmit - Fires when form is submitted
  2. handleSheetEdit - Fires when Requests or Movie Posters sheets are edited
  3. processAnnouncementQueue - Time-based, every 15 minutes

Event Flow on Form Submission:
  1. handleFormSubmit triggered
  2. Form answers parsed (name, add list, remove list, subscribe)
  3. Name format validated
  4. Subscriber added (if opted in)
  5. processSubmission_() called
     a. processRemovals_() - Mark posters as REMOVED
     b. processAdditions_() - Add new poster requests
  6. rebuildBoards() called
     a. buildMainBoard_() - Rebuild Main sheet
     b. buildEmployeesBoard_() - Rebuild Employees sheet
     c. syncEmployeeViewSpreadsheet_() - Sync to employee view
  7. syncPostersToForm() called
     a. Updates form Add choices
     b. Updates form Remove choices
  8. REQUEST_ORDER logged with results

Event Flow on Movie Posters Edit:
  1. handleSheetEdit triggered
  2. processMoviePostersEdit_() analyzes the row change
  3. If poster was activated, queueAnnouncement_() called
  4. syncPostersToForm() called to update form
  5. rebuildBoards() called to update views
  6. refreshPrintOut() called to update print layout

Time-Based Event (every 15 minutes):
  1. processAnnouncementQueue() runs
  2. Checks ANNOUNCE_QUEUE property
  3. Gets list of active subscribers
  4. Sends email to each subscriber with pending announcements
  5. Clears queue after sending

CONFIGURATION & CUSTOMIZATION
================================================================================

Main Configuration (00_Config.js):

  CONFIG.FORM_ID
    - Leave blank to auto-create form
    - Or paste specific form ID to use existing form
  
  CONFIG.FORM_META
    - Title: "Poster Request Form - Pasco"
    - Description: explains 5-poster limit and swap process
  
  CONFIG.SHEETS
    - Maps sheet names to variables
    - Easy to rename sheets without breaking code
  
  CONFIG.MAX_ACTIVE
    - Currently set to 5 (maximum posters per employee)
    - Change this value to adjust the limit
  
  CONFIG.TIMEZONE
    - Set to "America/Los_Angeles"
    - Adjust for different timezone if needed
  
  CONFIG.PROPS
    - Script properties used for storing JSON data
    - Keys for form ID, label maps, queues, etc.

Column Mappings (COLS object):

  COLS.REQUESTS
    - REQ_TS, EMP_EMAIL, EMP_NAME, POSTER_ID
    - LABEL_AT_REQ, TITLE_SNAP, RELEASE_SNAP
    - ACTION_TYPE, STATUS, STATUS_TS
  
  COLS.MOVIE_POSTERS
    - ACTIVE, POSTER_ID, TITLE, RELEASE
    - INV_COUNT, RECEIVED, NOTES, CLOSE_QUEUE
  
  COLS.SUBSCRIBERS
    - ACTIVE, EMAIL, NAME

Status Codes (STATUS object):

  STATUS.ACTIVE
    - Request is currently active (employee owns this poster)
  
  STATUS.REMOVED
    - Request was removed by employee (no longer owns)

Changing Limits:
  - To change max posters per employee: Change CONFIG.MAX_ACTIVE to new value
  - To change form title: Edit CONFIG.FORM_META.TITLE
  - To change timezone: Edit CONFIG.TIMEZONE

KNOWN LIMITATIONS & DESIGN DECISIONS
================================================================================

1. Inventory is Informational Only
   - Inventory counts are displayed but never block requests
   - Design decision: Fair access is more important than accuracy
   - Real inventory management should be separate system
   - Helps prevent "first-come" race conditions

2. Single Deduplication Mode
   - An employee can request a poster only once ever (historically)
   - Cannot re-request a poster they've requested before
   - Design decision: Prevents hoarding and encourages sharing
   - Could be changed to "once per active cycle" if desired

3. Google Account Required
   - Form requires Google sign-in (not optional)
   - Email auto-collected from Google Account
   - Design decision: Ensures accountability and prevents anonymous abuse
   - Setup: Must be configured in Form Settings > Responses

4. Manual Subscriber Opt-In
   - Subscribers added at submission time automatically
   - But can't be easily edited via form after initial submission
   - Design decision: Simple for employees, clear for auditing
   - Can be manually edited in Subscribers sheet if needed

5. No Approval Workflow
   - All requests processed immediately upon submission
   - No admin approval step
   - Design decision: Faster for employees, less friction
   - Could add approval step in future if needed

6. Removal Before Addition
   - If employee selects remove + add in same submission
   - Removals processed first, then additions
   - Design decision: Allows swapping posters within same submission
   - Otherwise would require two separate submissions

7. Employee View Separate Spreadsheet
   - Main spreadsheet contains sensitive admin data
   - Employee view contains only Main and Employees sheets
   - Design decision: Clear separation for safe sharing
   - Easier to manage permissions (employees as Viewers only)

TROUBLESHOOTING GUIDE
================================================================================

PROBLEM: Form submission not logging to Requests sheet

CAUSES:
  - Name format is invalid (e.g., "miles pratt" instead of "Miles P")
  - Triggers are not installed
  - Lock timeout (previous operation didn't release lock)

SOLUTIONS:
  - Check Request Order sheet for denial reason
  - Run "Run Setup / Repair" from admin menu
  - Wait a minute and try again
  - Check execution logs via Extensions > Apps Script > Executions

PROBLEM: Posters not appearing in form's "Request Posters (Add)" list

CAUSES:
  - Poster's Active? checkbox is FALSE
  - Title or Release Date field is empty
  - Form was not synced after adding poster

SOLUTIONS:
  - Check Movie Posters sheet: Active? = TRUE
  - Ensure both Title and Release Date are filled
  - Click "Sync Form Options Now" from admin menu
  - Wait 1-2 minutes for form to update

PROBLEM: Employee can't remove a poster they requested

CAUSES:
  - Poster status is not ACTIVE (already removed)
  - Form sync hasn't run yet
  - Different email address than when originally requested

SOLUTIONS:
  - Check Main board to see current active posters
  - Click "Sync Form Options Now" from admin menu
  - If wrong email, manually remove from Requests sheet

PROBLEM: Orphaned employee names appear at bottom of Main/Employees sheets

CAUSES:
  - This was a bug in earlier versions
  - Happens when posters are removed from Movie Posters

SOLUTIONS:
  - Click "Rebuild Boards Now" from admin menu
  - Rows should be automatically cleared

PROBLEM: Email announcements not being sent

CAUSES:
  - No subscribers (no one opted in)
  - Announcement queue is empty
  - Time-based trigger is disabled

SOLUTIONS:
  - Check Subscribers sheet for active subscribers
  - Click "Preview Pending Announcement" to see queue
  - Verify trigger exists: Extensions > Apps Script > Triggers
  - Try "Send Announcement Now" to manually trigger

PROBLEM: Employee View spreadsheet is not syncing

CAUSES:
  - Employee View spreadsheet not set up yet
  - Permissions issue
  - Sheet names don't match CONFIG.SHEETS

SOLUTIONS:
  - Click "Setup Employee View Spreadsheet" from admin menu
  - Share spreadsheet properly (admin > Viewer for employees)
  - Verify sheet names match (Main, Employees)
  - Check logs for error messages

PROJECT STATISTICS & METRICS
================================================================================

Code Statistics:
  - Total files: 15 JavaScript files
  - Total lines of code: ~1,100 lines
  - Functions: ~80 utility and handler functions
  - Configuration files: 1 (00_Config.js)

Sheet Statistics:
  - Total sheets: 9 in main spreadsheet
  - Automated sheets: 6 (Requests, Subscribers, Main, Employees, etc.)
  - Admin sheets: 3 (Movie Posters, Inventory, Print Out)
  - Documentation: 1 (auto-generated)

Trigger Statistics:
  - Form submission triggers: 1
  - Sheet edit triggers: 1
  - Time-based triggers: 1 (every 15 minutes)
  - Total: 3 active triggers

Data Capacity:
  - Requests can handle ~10,000 rows without performance issues
  - Each request = 1 row in Requests sheet
  - With 5-poster limit per employee, can support ~2,000 active employees
  - Scalable to larger organizations with modifications

Performance Metrics:
  - Form submission processing: ~2-3 seconds
  - Board rebuild: ~3-5 seconds
  - Full sync including employee view: ~5-8 seconds
  - Announcement batch processing: ~1-2 seconds

FUTURE ENHANCEMENT IDEAS
================================================================================

Potential improvements for future versions:

1. Email Notifications on Request Status
   - Send email to employee when request is approved/denied
   - Include reason for denial

2. Request History View
   - Show employee's past 10 requests (including removed)
   - Help employees make informed decisions

3. Poster Categories
   - Tag posters by category (Action, Comedy, etc.)
   - Filter form by category
   - Track category preferences

4. Advanced Admin Dashboard
   - Charts showing request trends
   - Employee activity stats
   - Inventory health metrics
   - Popular vs. unpopular posters

5. Approval Workflow
   - Add optional approval step for admins
   - Admin can approve/deny requests before they go active
   - Good for cost control

6. Request Expiration
   - Auto-remove requests after X days
   - Help manage stale requests

7. Mobile-Friendly Views
   - Responsive design for phones
   - Better mobile form experience

8. API Integration
   - Connect to HR system for employee data
   - Sync to inventory management system
   - Integration with email/calendar systems

9. Bulk Import/Export
   - Import historical data
   - Export reports to CSV/PDF
   - Backup and restore functionality

10. Enhanced Analytics
    - Request completion rate
    - Average time to fulfill
    - Employee engagement metrics
    - Forecasting tools

CONTACT & SUPPORT
================================================================================

System Owner: [Your Name]
Last Updated: January 20, 2026
Version: 1.1 (Optimized)

For questions or issues with the system:
  - Check TROUBLESHOOTING GUIDE section above
  - Review execution logs: Extensions > Apps Script > Executions
  - Check Request Order sheet for submission details
  - Test with "Run Setup / Repair" to reset system

================================================================================
                              END OF DOCUMENTATION
================================================================================
